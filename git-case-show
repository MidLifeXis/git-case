#!/bin/bash
#
# Assumptions:
#  - in a git repository
#  - we can access git-case-common
#  - the branch defined by GIT_CASE_HEAD exists (see git-case-common)

source git-case-common

ID=$(cat "$GIT_CASE_ACTIVE" 2>/dev/null || true)
test -z "$ID" && die "no active case set"

CASE_ROOT="cases:${ID}"

desc=$(git show "$CASE_ROOT/description" 2>/dev/null || true)
test -z "$desc" && die "active case is not valid"

ctype=$(git show "$CASE_ROOT/type" 2>/dev/null || true)
state=$(git show "$CASE_ROOT/state" 2>/dev/null || true)
found=$(git show "$CASE_ROOT/found" 2>/dev/null || true)

found=$(git log -1 --pretty=oneline --abbrev-commit "$found" || echo "$found")

echo "Case ID:     ${ID:0:6} ($ID)"
echo "Description: $desc"
echo "Type:        $ctype"
echo "State:       $state"
echo "Found in:    $found"

MARKS=$(git ls-tree cases "$ID/marks/" | awk -F/ '{ print $3 }' | xargs)
test -n "$MARKS" && echo "Marks:       $MARKS"

COMMENT_FILESS=$(git ls-tree cases -- "$ID/comments/")
test -z "$COMMENT_FILESS" && exit 0

echo
echo "Comments..."
git ls-tree cases -- "$ID/comments/" | while read mode type object file ; do
        if test $type = blob ; then
                short=${file##*/}
                echo "  $short"
                git cat-file blob $object | sed 's/^/    /'
                echo
        fi
done
