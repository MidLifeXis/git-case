#!/bin/bash
#
# Assumptions:
#  - in a git repository
#  - we can access git-case-common

source git-case-common

DESCRIPTION=$@
test -z "$DESCRIPTION" && die "$0 <description>"

CASE_ID=$(generate_case_id "$DESCRIPTION")
shortID=$(gen_short_case_id "$CASE_ID")

# we work in the working dir
go_to_git_case_work_dir

COMMIT_PARENT_ARGS=
if test -n "$(git rev-parse --revs-only ${GIT_CASE_HEAD})" ; then
        # already initialized, reset index to last commit
        git read-tree -i --reset "$GIT_CASE_HEAD"
        COMMIT_PARENT_ARGS="-p $GIT_CASE_HEAD"
else
        # reset the cache
        git read-tree -i --reset $(printf '' | git write-tree)
fi

# build the tree
add_file_to_index "$CASE_ID/description" "$DESCRIPTION"
add_file_to_index "$CASE_ID/type"        "bug"
add_file_to_index "$CASE_ID/state"       "new"
echo "$GIT_COMMITTER_NAME <$GIT_COMMITTER_EMAIL>" | add_file_to_index "$CASE_ID/assigned"

git rev-parse HEAD | add_file_to_index "$CASE_ID/found"
date               | add_file_to_index "$CASE_ID/created"

commit_index_and_update_branch "$DESCRIPTION" "$COMMIT_PARENT_ARGS"

echo -e "New case $yellow$shortID$reset created."
