#!/bin/bash
#
# Assumptions:
#  - in a git repository
#  - the branch defined by GIT_CASE_HEAD exists (see git-case-common)

source git-case-common

DESCRIPTION=$@
test -z "$DESCRIPTION" && die "$0 <description>"

CASE_NAME=$(date +%Y%m%d-%H%M%S.%N:)$(echo -n "$DESCRIPTION" | tr -c "a-zA-Z0-9" -)

# we work in the working dir
test -d "$GIT_CASE_WORK_DIR" && die "stale $GIT_CASE_WORK_DIR already exists"
trap "cd $GIT_DIR ; rm -rf $GIT_CASE_WORK_DIR; exit" INT TERM EXIT
mkdir -p "$GIT_CASE_WORK_DIR"
cd "$GIT_CASE_WORK_DIR"

# build the tree
mkdir -p "$CASE_NAME"
echo "$DESCRIPTION"                           > "$CASE_NAME/description"
git rev-parse HEAD                            > "$CASE_NAME/found"
echo new                                      > "$CASE_NAME/state"
echo v0.0                                     > "$CASE_NAME/version"

COMMIT_PARENT_ARGS=
if test -n "$(git-rev-parse --revs-only ${GIT_CASE_HEAD})" ; then
        # already initialized, reset index to last commit
        git read-tree -i --reset "$GIT_CASE_HEAD"
        COMMIT_PARENT_ARGS="-p $GIT_CASE_HEAD"
else
        # reset the cache
        git-rm --cached -q -r .
fi

git update-index --add "$CASE_NAME/description"
git update-index --add "$CASE_NAME/found"
git update-index --add "$CASE_NAME/state"
git update-index --add "$CASE_NAME/version"

TREE=$(git write-tree)
test -z "$TREE" && die "failed to write tree"

COMMIT=$(echo "$DESCRIPTION" | git commit-tree ${TREE} ${COMMIT_PARENT_ARGS})
test -z "$COMMIT" && die "failed to create commit"

echo "$COMMIT" > "${GIT_DIR}/refs/heads/$GIT_CASE_HEAD"

